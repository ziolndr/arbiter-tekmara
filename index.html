<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARBITER | Aquarius Decision Support</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --black: #000000;
            --dark: #0a0a0a;
            --border: #1a1a1a;
            --border-hover: #2a2a2a;
            --gray: #64748b;
            --gray-light: #94a3b8;
            --white: #f1f5f9;
            --green: #10b981;
            --amber: #f59e0b;
            --red: #ef4444;
            --blue: #3b82f6;
            --cyan: #06b6d4;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--black);
            color: var(--white);
            font-size: 13px;
            line-height: 1.5;
            overflow: hidden;
        }

        /* Header */
        .header {
            height: 56px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: var(--dark);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .logo-badge {
            font-size: 10px;
            color: var(--gray);
            padding: 4px 8px;
            background: var(--black);
            border: 1px solid var(--border);
            border-radius: 4px;
            letter-spacing: 0.05em;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 11px;
            color: var(--gray);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-item .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: pulse 2s ease infinite;
        }

        .status-item .status-online { background: var(--green); }
        .status-item .status-offline { background: var(--red); }

        /* Mode Toggle Buttons */
        .mode-btn {
            padding: 8px 16px;
            background: var(--black);
            border: 1px solid var(--border);
            color: var(--gray);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .mode-btn:hover {
            border-color: var(--border-hover);
            color: var(--gray-light);
        }

        .mode-btn.active {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Main Layout */
        .main {
            height: calc(100vh - 56px);
            display: grid;
            grid-template-columns: 340px 1fr 400px;
        }

        .panel {
            border-right: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--dark);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .panel-title {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--gray);
        }

        .section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 16px;
        }

        /* Form Controls */
        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            font-size: 11px;
            color: var(--gray-light);
            margin-bottom: 6px;
            display: block;
        }

        .select-field, .input-field {
            width: 100%;
            padding: 10px 12px;
            background: var(--dark);
            border: 1px solid var(--border);
            color: var(--white);
            font-family: inherit;
            font-size: 13px;
            border-radius: 0;
            transition: border-color 0.2s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .select-field {
            background-image: none;
            cursor: pointer;
        }

        .select-field::-ms-expand {
            display: none;
        }

        .select-field:focus, .input-field:focus {
            outline: none;
            border-color: var(--blue);
        }

        .select-field:hover, .input-field:hover {
            border-color: var(--border-hover);
        }

        /* Sensor Grid */
        .sensor-grid {
            display: grid;
            gap: 12px;
        }

        .sensor-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 0;
        }

        .sensor-label {
            font-size: 12px;
            color: var(--gray-light);
            flex: 1;
        }

        .sensor-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stepper-btn {
            width: 28px;
            height: 28px;
            background: var(--black);
            border: 1px solid var(--border);
            color: var(--white);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0;
            transition: all 0.15s;
            user-select: none;
        }

        .stepper-btn:hover {
            border-color: var(--blue);
            color: var(--blue);
        }

        .stepper-btn:active {
            transform: scale(0.95);
        }

        .stepper-value {
            min-width: 50px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .sensor-unit {
            font-size: 11px;
            color: var(--gray);
            margin-left: 4px;
        }

        /* Checkboxes */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.15s;
        }

        .checkbox-item:hover {
            background: var(--dark);
        }

        .checkbox {
            width: 18px;
            height: 18px;
            border: 1px solid var(--border);
            background: var(--black);
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .checkbox-item input[type="checkbox"] {
            display: none;
        }

        .checkbox-item input[type="checkbox"]:checked + .checkbox {
            background: var(--blue);
            border-color: var(--blue);
        }

        .checkbox-item input[type="checkbox"]:checked + .checkbox::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .checkbox-label {
            font-size: 12px;
            color: var(--gray-light);
        }

        /* Radio Buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 0;
            background: var(--dark);
            transition: all 0.15s;
        }

        .radio-item:hover {
            border-color: var(--border-hover);
        }

        .radio-item.selected {
            border-color: var(--blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .radio-dot {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .radio-item.selected .radio-dot {
            border-color: var(--blue);
        }

        .radio-item.selected .radio-dot::after {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--blue);
            border-radius: 50%;
        }

        .radio-label {
            font-size: 12px;
            flex: 1;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px 20px;
            background: var(--dark);
            color: var(--white);
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 0;
            transition: all 0.2s;
            letter-spacing: 0.02em;
        }

        .btn:hover {
            border-color: var(--border-hover);
            background: var(--border);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--black);
            border: 1px solid var(--border);
            color: var(--gray-light);
        }

        .btn-secondary:hover {
            background: var(--dark);
            border-color: var(--border-hover);
            color: var(--white);
        }

        /* Recommendation Cards */
        .recommendations {
            padding: 20px;
            flex: 1;
        }

        .rec-card {
            background: var(--dark);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 16px;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .rec-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .rec-card.selected {
            border-color: var(--amber);
            border-width: 2px;
            padding: 19px;
        }

        .rec-rank {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--black);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: var(--gray);
        }

        .rec-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-right: 40px;
        }

        .rec-score-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .rec-score-bar {
            flex: 1;
            height: 6px;
            background: var(--black);
            border-radius: 3px;
            overflow: hidden;
        }

        .rec-score-fill {
            height: 100%;
            background: var(--green);
            border-radius: 3px;
            transition: width 0.6s ease;
        }

        .rec-score-value {
            font-size: 14px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            color: var(--green);
            min-width: 50px;
            text-align: right;
        }

        .rec-description {
            font-size: 12px;
            color: var(--gray-light);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .rec-support {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .support-badge {
            font-size: 10px;
            padding: 4px 8px;
            background: var(--black);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--gray-light);
        }

        .candidate-item {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 0;
            transition: all 0.15s;
        }

        .candidate-item:hover {
            border-color: var(--border-hover);
        }

        .candidate-item.editing {
            border-color: var(--blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .candidate-number {
            font-size: 11px;
            color: var(--gray);
            font-weight: 600;
            min-width: 20px;
            padding-top: 2px;
        }

        .candidate-content {
            flex: 1;
        }

        .candidate-text {
            font-size: 12px;
            color: var(--gray-light);
            line-height: 1.6;
            cursor: text;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background 0.15s;
        }

        .candidate-text:hover {
            background: var(--black);
        }

        .candidate-input {
            width: 100%;
            background: var(--black);
            border: 1px solid var(--blue);
            color: var(--white);
            padding: 8px;
            font-family: inherit;
            font-size: 12px;
            border-radius: 0;
            resize: vertical;
            min-height: 60px;
        }

        .candidate-input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .candidate-actions {
            display: flex;
            gap: 6px;
            align-items: flex-start;
        }

        .candidate-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--gray-light);
            cursor: pointer;
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 0;
            transition: all 0.15s;
            white-space: nowrap;
            font-weight: 500;
        }

        .candidate-btn:hover {
            border-color: var(--border-hover);
            background: var(--black);
        }

        .candidate-btn.edit {
            color: var(--blue);
            border-color: var(--blue);
        }

        .candidate-btn.delete {
            color: var(--red);
            border-color: var(--red);
        }

        .candidate-btn.delete:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .candidate-btn.save {
            background: var(--blue);
            color: white;
            border-color: var(--blue);
        }

        .candidate-btn.save:hover {
            background: #2563eb;
        }

        .candidate-btn.cancel {
            background: var(--dark);
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            margin-bottom: 6px;
        }

        .loading-subtext {
            font-size: 12px;
            color: var(--gray);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray);
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--gray-light);
        }

        .empty-description {
            font-size: 12px;
        }

        /* Perspective Cards */
        .perspective-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .perspective-card {
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 0;
            overflow: hidden;
            transition: all 0.2s;
        }

        .perspective-card:hover {
            border-color: var(--border-hover);
        }

        .perspective-header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .perspective-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .perspective-emoji {
            font-size: 16px;
            font-weight: 600;
        }

        .perspective-name {
            font-size: 12px;
            font-weight: 600;
        }

        .perspective-rec {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 0;
            letter-spacing: 0.02em;
        }

        .rec-abort { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .rec-warning { background: rgba(245, 158, 11, 0.2); color: var(--amber); }
        .rec-ambiguous { background: rgba(245, 158, 11, 0.15); color: var(--amber); }
        .rec-diagnostic { background: rgba(6, 182, 212, 0.2); color: var(--cyan); }
        .rec-ok { background: rgba(16, 185, 129, 0.2); color: var(--green); }

        .perspective-score {
            font-size: 13px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            color: var(--gray-light);
            margin-left: 12px;
        }

        .perspective-expand {
            font-size: 10px;
            color: var(--gray);
            transition: transform 0.2s;
        }

        .perspective-card.expanded .perspective-expand {
            transform: rotate(180deg);
        }

        .perspective-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .perspective-card.expanded .perspective-body {
            max-height: 500px;
        }

        .perspective-content {
            padding: 16px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--gray-light);
            line-height: 1.7;
        }

        .perspective-options {
            margin-top: 12px;
        }

        .option-item {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: var(--black);
            border-radius: 0;
        }

        .option-score {
            font-variant-numeric: tabular-nums;
            color: var(--cyan);
            font-weight: 600;
            min-width: 45px;
        }

        .option-text {
            flex: 1;
            color: var(--gray-light);
        }

        /* Consensus Banner */
        .consensus-banner {
            padding: 20px;
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 0;
            margin-bottom: 20px;
        }

        .consensus-title {
            font-size: 10px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 12px;
        }

        .consensus-stat {
            font-size: 24px;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 6px;
        }

        .consensus-detail {
            font-size: 12px;
            color: var(--gray-light);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-hover);
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .main {
                grid-template-columns: 1fr;
                overflow-y: auto;
            }

            .panel {
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: none;
            }

            .header {
                padding: 0 16px;
            }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1200px) {
            .main {
                grid-template-columns: 1fr !important;
                height: auto !important;
                overflow-y: auto !important;
            }
            
            .panel {
                border-right: none !important;
                border-bottom: 1px solid var(--border);
                overflow-y: visible !important;
                height: auto !important;
                max-height: none !important;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                gap: 12px;
                padding: 12px 16px;
                height: auto;
            }
            
            .status-bar {
                width: 100%;
                justify-content: space-between;
                font-size: 10px !important;
            }
            
            .mode-btn {
                font-size: 10px;
                padding: 6px 12px;
            }
            
            .sensor-row {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }
            
            .sensor-controls {
                width: 100%;
                justify-content: space-between !important;
            }
            
            .rec-card {
                padding: 16px !important;
            }
            
            .section {
                padding: 16px !important;
            }
            
            .btn, .btn-secondary {
                padding: 12px !important;
                font-size: 13px !important;
                min-height: 44px;
            }
            
            .checkbox-item {
                padding: 12px !important;
                min-height: 44px;
            }
            
            .stepper-btn {
                width: 44px !important;
                height: 44px !important;
                font-size: 20px !important;
            }
            
            .candidate-btn {
                padding: 10px 14px !important;
                font-size: 12px !important;
                min-height: 44px;
            }
            
            .input-field {
                padding: 12px !important;
                font-size: 14px !important;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 8px 12px;
            }
            
            .logo-text {
                font-size: 14px;
            }
            
            .logo-badge {
                font-size: 8px;
                padding: 3px 6px;
            }
            
            .status-item {
                font-size: 9px !important;
            }
            
            .section-title {
                font-size: 9px;
            }
            
            .rec-title {
                font-size: 13px !important;
            }
            
            .rec-rank {
                width: 28px !important;
                height: 28px !important;
                font-size: 13px !important;
            }
            
            .section {
                padding: 12px !important;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }

            .left-panel {
                border-right: none;
                border-bottom: 2px solid var(--border);
                max-height: none;
                overflow-y: visible;
            }

            .center-panel {
                border-right: none;
                border-bottom: 2px solid var(--border);
            }

            .right-panel {
                border-right: none;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                padding: 16px;
            }

            .mode-toggle {
                width: 100%;
                justify-content: center;
            }

            .mode-btn {
                flex: 1;
                justify-content: center;
            }

            .status-bar {
                flex-wrap: wrap;
                gap: 8px;
            }

            .status-item {
                font-size: 10px;
            }

            .section {
                padding: 16px;
            }

            .section-title {
                font-size: 10px;
            }

            .rec-card {
                padding: 16px;
            }

            .rec-title {
                font-size: 14px;
            }

            .perspective-card {
                margin-bottom: 12px;
            }

            .perspective-name {
                font-size: 12px;
            }

            .consensus-banner {
                padding: 16px;
            }

            .consensus-stat {
                font-size: 20px;
            }

            /* Make checkboxes and radio items easier to tap on mobile */
            .checkbox-item, .radio-item {
                padding: 14px 12px;
                min-height: 48px;
            }

            .checkbox-label {
                font-size: 13px;
            }

            /* Larger touch targets for buttons */
            .btn, .btn-secondary {
                padding: 14px 20px;
                font-size: 13px;
                min-height: 48px;
            }

            /* Sensor controls easier to use on mobile */
            .stepper-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            /* Make input fields larger on mobile */
            .input-field, .select-field {
                padding: 12px;
                font-size: 14px;
            }

            textarea.input-field {
                min-height: 80px;
            }

            /* Modal adjustments */
            #addPerspectiveModal > div,
            #createScenarioModal > div {
                width: 95%;
                max-width: none;
                margin: 0 auto;
            }

            /* Scenario selector larger on mobile */
            .select-field {
                font-size: 14px;
                padding: 12px;
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: 12px;
            }

            #modeBadge {
                font-size: 11px;
                padding: 6px 12px;
            }

            .mode-btn {
                font-size: 11px;
                padding: 8px 16px;
            }

            .status-item {
                font-size: 9px;
            }

            .section {
                padding: 12px;
            }

            .rec-rank {
                width: 28px;
                height: 28px;
                font-size: 13px;
            }

            .rec-title {
                font-size: 13px;
            }

            .rec-score-value {
                font-size: 13px;
            }

            .support-badge {
                font-size: 9px;
                padding: 4px 8px;
            }

            /* Stack buttons vertically on very small screens */
            .section > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }

            /* Single column for modal radio options */
            #createScenarioModal label[style*="display: flex"] {
                flex-direction: column;
                align-items: flex-start !important;
            }

            .consensus-stat {
                font-size: 18px;
            }

            .perspective-emoji {
                font-size: 16px;
            }
        }

        /* Landscape mobile orientation */
        @media (max-width: 1024px) and (orientation: landscape) {
            .container {
                grid-template-columns: 350px 1fr 1fr;
                grid-template-rows: 1fr;
            }

            .left-panel {
                border-right: 2px solid var(--border);
                border-bottom: none;
                max-height: calc(100vh - 140px);
                overflow-y: auto;
            }

            .center-panel {
                border-right: 2px solid var(--border);
                border-bottom: none;
            }

            .right-panel {
                border-right: none;
            }
        }

        /* Tablet specific adjustments */
        @media (min-width: 641px) and (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto 1fr;
            }

            .left-panel {
                grid-column: 1 / -1;
                border-bottom: 2px solid var(--border);
            }

            .center-panel {
                border-right: 2px solid var(--border);
                border-bottom: none;
            }

            .right-panel {
                border-right: none;
            }

            .section {
                padding: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <div class="logo-text">ARBITER</div>
            <div class="logo-badge" id="modeBadge">AQUARIUS</div>
        </div>
        
        <!-- Mode Toggle -->
        <div style="display: flex; gap: 8px;">
            <button class="mode-btn active" id="modeAquarius" onclick="switchMode('aquarius')">
                AQUARIUS
            </button>
            <button class="mode-btn" id="modeSmartLab" onclick="switchMode('smartlab')">
                SMART LAB
            </button>
        </div>
        
        <div class="status-bar" id="statusBar">
            <div class="status-item">
                <div class="status-dot status-offline"></div>
                <span>COMMS OFFLINE</span>
            </div>
            <div class="status-item">
                <span>DAY 12/21</span>
            </div>
            <div class="status-item">
                <span>6 CREW</span>
            </div>
            <div class="status-item">
                <span id="timestamp">--:--:--</span>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main">
        <!-- LEFT PANEL: Configuration -->
        <div class="panel">
            <!-- Current Scenario Header - PROMINENT -->
            <div style="padding: 20px; border-bottom: 2px solid var(--border); background: var(--dark);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div style="font-size: 10px; letter-spacing: 0.1em; color: var(--gray); font-weight: 600;">
                        SCENARIO
                    </div>
                    <div id="saveIndicator" style="font-size: 10px; color: var(--green); opacity: 0; transition: opacity 0.3s;">
                        ✓ SAVED
                    </div>
                </div>
                <select class="select-field" id="scenarioSelector" onchange="switchToScenario()" style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">
                    <optgroup label="TEMPLATES">
                        <option value="equipment-anomaly">Equipment Anomaly</option>
                        <option value="medical-emergency">Medical Emergency</option>
                        <option value="mission-planning">Mission Planning</option>
                        <option value="weather-event">Weather Event</option>
                    </optgroup>
                    <optgroup label="YOUR SCENARIOS" id="customScenariosGroup" style="display: none;">
                        <!-- Custom scenarios will appear here -->
                    </optgroup>
                </select>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px;">
                    <button class="btn-secondary btn" onclick="createBlankScenario()" style="padding: 8px; font-size: 11px;">
                        New Scenario
                    </button>
                    <button class="btn-secondary btn" onclick="saveAsNewScenario()" style="padding: 8px; font-size: 11px;">
                        Save As...
                    </button>
                    <button class="btn-secondary btn" onclick="duplicateScenario()" style="padding: 8px; font-size: 11px;">
                        Duplicate
                    </button>
                </div>
                <div id="deleteScenarioBtn" style="margin-top: 6px; display: none;">
                    <button class="btn-secondary btn" onclick="deleteCurrentScenario()" style="padding: 8px; font-size: 11px; width: 100%; color: var(--red);">
                        Delete This Scenario
                    </button>
                </div>
            </div>

            <!-- AQUARIUS MODE CONTENT -->
            <div id="aquariusConfig">
            <!-- Sensor Data -->
            <div class="section">
                <div class="section-title">Sensor Data</div>
                <div class="sensor-grid">
                    <div class="sensor-row">
                        <div class="sensor-label">CO2 Scrubber</div>
                        <div class="sensor-controls">
                            <button class="stepper-btn" onclick="adjustSensor('scrubber', -1)">−</button>
                            <div class="stepper-value">
                                <span id="scrubber-value">87</span><span class="sensor-unit">%</span>
                            </div>
                            <button class="stepper-btn" onclick="adjustSensor('scrubber', 1)">+</button>
                        </div>
                    </div>

                    <div class="sensor-row">
                        <div class="sensor-label">Temperature</div>
                        <div class="sensor-controls">
                            <button class="stepper-btn" onclick="adjustSensor('temperature', -1)">−</button>
                            <div class="stepper-value">
                                <span id="temperature-value">+3</span><span class="sensor-unit">°C</span>
                            </div>
                            <button class="stepper-btn" onclick="adjustSensor('temperature', 1)">+</button>
                        </div>
                    </div>

                    <div class="sensor-row">
                        <div class="sensor-label">Mission Day</div>
                        <div class="sensor-controls">
                            <button class="stepper-btn" onclick="adjustSensor('day', -1)">−</button>
                            <div class="stepper-value">
                                <span id="day-value">12</span><span class="sensor-unit">/21</span>
                            </div>
                            <button class="stepper-btn" onclick="adjustSensor('day', 1)">+</button>
                        </div>
                    </div>

                    <div class="sensor-row">
                        <div class="sensor-label">Crew Count</div>
                        <div class="sensor-controls">
                            <button class="stepper-btn" onclick="adjustSensor('crew', -1)">−</button>
                            <div class="stepper-value" id="crew-value">6</div>
                            <button class="stepper-btn" onclick="adjustSensor('crew', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Context -->
            <div class="section">
                <div class="section-title">Additional Context</div>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" id="ctx-comms" checked>
                        <div class="checkbox"></div>
                        <span class="checkbox-label">Surface communications offline</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="ctx-test" checked>
                        <div class="checkbox"></div>
                        <span class="checkbox-label">Pattern started after equipment test</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="ctx-ai" checked>
                        <div class="checkbox"></div>
                        <span class="checkbox-label">AI system recommends continue</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="ctx-weather">
                        <div class="checkbox"></div>
                        <span class="checkbox-label">Surface weather deteriorating</span>
                    </label>
                </div>

                <div style="margin-top: 16px;">
                    <div style="font-size: 10px; color: var(--gray); margin-bottom: 8px; letter-spacing: 0.05em;">
                        CUSTOM CONTEXT
                    </div>
                    <textarea 
                        id="customContextInput" 
                        class="input-field" 
                        placeholder="Add situational context... (e.g., 'Backup scrubber also degraded')"
                        rows="2"
                        style="resize: vertical; margin-bottom: 8px;"
                    ></textarea>
                    <button class="btn-secondary btn" onclick="addCustomContext()">
                        + Add Context
                    </button>
                </div>

                <div id="customContextList" style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
                    <!-- Custom contexts will appear here -->
                </div>
            </div>

            <!-- Analyze As -->
            <div class="section">
                <div class="section-title">Analyze From Perspective</div>
                
                <label class="checkbox-item" style="background: var(--black); border: 1px solid var(--blue); margin-bottom: 12px;">
                    <input type="checkbox" id="selectAllPerspectives" checked onchange="toggleAllPerspectives()">
                    <div class="checkbox"></div>
                    <span class="checkbox-label" style="font-weight: 600;">All Perspectives</span>
                </label>
                
                <div style="font-size: 10px; color: var(--gray); margin: 16px 0 8px 0; letter-spacing: 0.05em;">
                    STANDARD PERSPECTIVES
                </div>
                
                <div class="checkbox-group" id="standardRoles">
                    <label class="checkbox-item">
                        <input type="checkbox" class="perspective-checkbox" data-role="safety" checked>
                        <div class="checkbox"></div>
                        <span class="checkbox-label">Dive Safety Officer</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="perspective-checkbox" data-role="researcher" checked>
                        <div class="checkbox"></div>
                        <span class="checkbox-label">Lead Researcher</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="perspective-checkbox" data-role="commander" checked>
                        <div class="checkbox"></div>
                        <span class="checkbox-label">Mission Commander</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="perspective-checkbox" data-role="equipment" checked>
                        <div class="checkbox"></div>
                        <span class="checkbox-label">Equipment System</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="perspective-checkbox" data-role="control" checked>
                        <div class="checkbox"></div>
                        <span class="checkbox-label">Mission Control</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" class="perspective-checkbox" data-role="liability" checked>
                        <div class="checkbox"></div>
                        <span class="checkbox-label">Liability Assessment</span>
                    </label>
                </div>

                <div id="customPerspectivesSection" style="display: none;">
                    <div style="font-size: 10px; color: var(--gray); margin: 16px 0 8px 0; letter-spacing: 0.05em;">
                        CUSTOM PERSPECTIVES (<span id="customPerspectiveCount">0</span>)
                    </div>
                    <div class="checkbox-group" id="customRoles">
                        <!-- Custom perspectives will be rendered here -->
                    </div>
                </div>

                <button class="btn-secondary btn" onclick="openAddPerspectiveModal()" style="margin-top: 12px;">
                    + Add Custom Perspective
                </button>
            </div>

            <!-- Decision Options -->
            <div class="section">
                <div class="section-title">Decision Options</div>
                <div id="candidatesList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                    <!-- Candidates will be rendered here -->
                </div>
                <button class="btn-secondary btn" onclick="addCandidate()">
                    + Add Option
                </button>
            </div>

            <!-- Run Analysis Button -->
            <div class="section">
                <button class="btn" onclick="runAnalysis()" id="analyzeBtn">
                    Run Analysis
                </button>
            </div>
            </div>
            <!-- END AQUARIUS MODE CONTENT -->

            <!-- SMART LAB MODE CONTENT -->
            <div id="smartLabConfig" style="display: none;">
                <!-- Smart Lab Sensors -->
                <div class="section">
                    <div class="section-title">Environmental Sensors</div>
                    <div class="sensor-grid">
                        <div class="sensor-row">
                            <div class="sensor-label">Surface Vessels (1km radius)</div>
                            <div class="sensor-controls">
                                <button class="stepper-btn" onclick="adjustSmartLabSensor('vessels', -1)">−</button>
                                <div class="stepper-value" id="vessels-value">0</div>
                                <button class="stepper-btn" onclick="adjustSmartLabSensor('vessels', 1)">+</button>
                            </div>
                        </div>

                        <div class="sensor-row">
                            <div class="sensor-label">Hydrocarbons (ppb)</div>
                            <div class="sensor-controls">
                                <button class="stepper-btn" onclick="adjustSmartLabSensor('hydrocarbons', -5)">−</button>
                                <div class="stepper-value">
                                    <span id="hydrocarbons-value">12</span><span class="sensor-unit">ppb</span>
                                </div>
                                <button class="stepper-btn" onclick="adjustSmartLabSensor('hydrocarbons', 5)">+</button>
                            </div>
                        </div>

                        <div class="sensor-row">
                            <div class="sensor-label">Wireless Throughput</div>
                            <div class="sensor-controls">
                                <button class="stepper-btn" onclick="adjustSmartLabSensor('wireless', -5)">−</button>
                                <div class="stepper-value">
                                    <span id="wireless-value">94</span><span class="sensor-unit">%</span>
                                </div>
                                <button class="stepper-btn" onclick="adjustSmartLabSensor('wireless', 5)">+</button>
                            </div>
                        </div>

                        <div class="sensor-row">
                            <div class="sensor-label">AUV Fleet (active units)</div>
                            <div class="sensor-controls">
                                <button class="stepper-btn" onclick="adjustSmartLabSensor('auvFleet', -1)">−</button>
                                <div class="stepper-value" id="auvFleet-value">3</div>
                                <button class="stepper-btn" onclick="adjustSmartLabSensor('auvFleet', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Autonomous Context -->
                <div class="section">
                    <div class="section-title">Autonomous Detection</div>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="sl-ctx-unauthorized">
                            <div class="checkbox"></div>
                            <span class="checkbox-label">Unauthorized diver detected</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="sl-ctx-oxygen" checked>
                            <div class="checkbox"></div>
                            <span class="checkbox-label">AI anomaly: oxygen depletion pattern</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="sl-ctx-station">
                            <div class="checkbox"></div>
                            <span class="checkbox-label">AUV fleet: station keeping mode</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="sl-ctx-pollution">
                            <div class="checkbox"></div>
                            <span class="checkbox-label">Pollution source: tracking active</span>
                        </label>
                    </div>
                </div>

                <!-- Smart Lab Perspectives -->
                <div class="section">
                    <div class="section-title">Analyze From Perspective</div>
                    
                    <label class="checkbox-item" style="background: var(--black); border: 1px solid var(--blue); margin-bottom: 12px;">
                        <input type="checkbox" id="selectAllSmartLabPerspectives" checked onchange="toggleAllSmartLabPerspectives()">
                        <div class="checkbox"></div>
                        <span class="checkbox-label" style="font-weight: 600;">All Perspectives</span>
                    </label>
                    
                    <div class="checkbox-group" id="smartLabRoles">
                        <label class="checkbox-item">
                            <input type="checkbox" class="smartlab-perspective-checkbox" data-role="sl-enforcement" checked>
                            <div class="checkbox"></div>
                            <span class="checkbox-label">Sanctuary Enforcement</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" class="smartlab-perspective-checkbox" data-role="sl-research" checked>
                            <div class="checkbox"></div>
                            <span class="checkbox-label">Tekmara Lead Scientist</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" class="smartlab-perspective-checkbox" data-role="sl-compliance" checked>
                            <div class="checkbox"></div>
                            <span class="checkbox-label">NOAA Compliance Officer</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" class="smartlab-perspective-checkbox" data-role="sl-robotics" checked>
                            <div class="checkbox"></div>
                            <span class="checkbox-label">Autonomous Systems (AUV)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" class="smartlab-perspective-checkbox" data-role="sl-conservation" checked>
                            <div class="checkbox"></div>
                            <span class="checkbox-label">Marine Sanctuary Protection</span>
                        </label>
                    </div>
                </div>

                <!-- Run Analysis -->
                <div class="section">
                    <button class="btn" onclick="runAnalysis()" id="analyzeBtn2">
                        Run Coherence Analysis
                    </button>
                </div>
            </div>
            <!-- END SMART LAB MODE CONTENT -->

        </div>

        <!-- CENTER PANEL: Recommendations -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Ranked Recommendations</div>
            </div>
            <div class="recommendations" id="recommendationsPanel">
                <div class="empty-state">
                    <div class="empty-icon">○</div>
                    <div class="empty-title">Ready for Analysis</div>
                    <div class="empty-description">
                        Configure the scenario parameters and click "Run Analysis" to see recommendations ranked by geometric coherence.
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Perspectives -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Perspective Breakdown</div>
            </div>
            <div class="section" id="perspectivesPanel">
                <div class="empty-state">
                    <div class="empty-icon">○</div>
                    <div class="empty-title">Awaiting Analysis</div>
                    <div class="empty-description">
                        Perspectives will appear here after running analysis.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Custom Perspective Modal -->
    <div id="addPerspectiveModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--dark); border: 1px solid var(--border); border-radius: 0; width: 90%; max-width: 500px; padding: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600;">Add Custom Perspective</div>
                <button onclick="closeAddPerspectiveModal()" style="background: none; border: none; color: var(--gray); cursor: pointer; font-size: 20px; padding: 0;">×</button>
            </div>

            <div style="margin-bottom: 16px;">
                <label class="input-label">Role Name</label>
                <input type="text" id="customRoleName" class="input-field" placeholder="e.g., NASA Flight Surgeon" maxlength="50">
            </div>

            <div style="margin-bottom: 20px;">
                <label class="input-label">Color</label>
                <select id="customRoleColor" class="select-field">
                    <option value="#ef4444">Red</option>
                    <option value="#3b82f6" selected>Blue</option>
                    <option value="#8b5cf6">Purple</option>
                    <option value="#f59e0b">Orange</option>
                    <option value="#06b6d4">Cyan</option>
                    <option value="#10b981">Green</option>
                    <option value="#eab308">Yellow</option>
                    <option value="#ec4899">Pink</option>
                </select>
            </div>

            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="saveCustomPerspective()" style="flex: 1;">Save Perspective</button>
                <button class="btn-secondary btn" onclick="closeAddPerspectiveModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Create Scenario Modal - Multi-Step Wizard -->
    <div id="createScenarioModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--dark); border: 1px solid var(--border); width: 90%; max-width: 600px; padding: 24px;">
            
            <!-- Step 1: Name & Type -->
            <div id="modalStep1">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 600;">Create New Scenario (Step 1 of 3)</div>
                    <button onclick="closeCreateScenarioModal()" style="background: none; border: none; color: var(--gray); cursor: pointer; font-size: 20px; padding: 0;">×</button>
                </div>

                <div style="margin-bottom: 16px;">
                    <label class="input-label">Scenario Name</label>
                    <input type="text" id="newScenarioName" class="input-field" placeholder="e.g., Day 12 - Backup Failure" maxlength="50">
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="input-label">Starting Configuration</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--black); border: 1px solid var(--border); cursor: pointer;">
                            <input type="radio" name="startingConfig" value="blank" checked style="cursor: pointer;" onchange="updateModalFlow()">
                            <div>
                                <div style="font-size: 13px; font-weight: 600;">Blank - Configure Now</div>
                                <div style="font-size: 11px; color: var(--gray);">Walk through configuration in next steps</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--black); border: 1px solid var(--border); cursor: pointer;">
                            <input type="radio" name="startingConfig" value="current" style="cursor: pointer;" onchange="updateModalFlow()">
                            <div>
                                <div style="font-size: 13px; font-weight: 600;">Copy Current State</div>
                                <div style="font-size: 11px; color: var(--gray);">Use all current sensor values, contexts, and candidates</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--black); border: 1px solid var(--border); cursor: pointer;">
                            <input type="radio" name="startingConfig" value="template" style="cursor: pointer;" onchange="updateModalFlow()">
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 600;">From Template</div>
                                <select id="templateSelector" class="select-field" style="margin-top: 8px; font-size: 12px;">
                                    <option value="equipment-anomaly">Equipment Anomaly</option>
                                    <option value="medical-emergency">Medical Emergency</option>
                                    <option value="mission-planning">Mission Planning</option>
                                    <option value="weather-event">Weather Event</option>
                                </select>
                            </div>
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn-secondary btn" onclick="closeCreateScenarioModal()">Cancel</button>
                    <button class="btn" onclick="modalNextStep()" id="step1NextBtn">Next</button>
                </div>
            </div>

            <!-- Step 2: Configure Sensors & Context (only for Blank) -->
            <div id="modalStep2" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 600;">Configure Sensors (Step 2 of 3)</div>
                    <button onclick="closeCreateScenarioModal()" style="background: none; border: none; color: var(--gray); cursor: pointer; font-size: 20px; padding: 0;">×</button>
                </div>

                <div style="margin-bottom: 16px;">
                    <label class="input-label">Sensor Values</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--black); border: 1px solid var(--border);">
                            <span style="font-size: 12px;">CO2 Scrubber</span>
                            <input type="number" id="modal-scrubber" value="85" min="0" max="100" style="width: 80px; padding: 6px; background: var(--dark); border: 1px solid var(--border); color: var(--white); text-align: center;">
                            <span style="font-size: 11px; color: var(--gray);">%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--black); border: 1px solid var(--border);">
                            <span style="font-size: 12px;">Temperature</span>
                            <input type="number" id="modal-temperature" value="0" min="-10" max="10" style="width: 80px; padding: 6px; background: var(--dark); border: 1px solid var(--border); color: var(--white); text-align: center;">
                            <span style="font-size: 11px; color: var(--gray);">°C</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--black); border: 1px solid var(--border);">
                            <span style="font-size: 12px;">Mission Day</span>
                            <input type="number" id="modal-day" value="1" min="1" max="21" style="width: 80px; padding: 6px; background: var(--dark); border: 1px solid var(--border); color: var(--white); text-align: center;">
                            <span style="font-size: 11px; color: var(--gray);">/21</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--black); border: 1px solid var(--border);">
                            <span style="font-size: 12px;">Crew Count</span>
                            <input type="number" id="modal-crew" value="6" min="1" max="12" style="width: 80px; padding: 6px; background: var(--dark); border: 1px solid var(--border); color: var(--white); text-align: center;">
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="input-label">Context Flags</label>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="display: flex; gap: 10px; align-items: center; font-size: 12px;">
                            <input type="checkbox" id="modal-ctx-comms"> <span>Surface communications offline</span>
                        </label>
                        <label style="display: flex; gap: 10px; align-items: center; font-size: 12px;">
                            <input type="checkbox" id="modal-ctx-test"> <span>Pattern started after equipment test</span>
                        </label>
                        <label style="display: flex; gap: 10px; align-items: center; font-size: 12px;">
                            <input type="checkbox" id="modal-ctx-ai"> <span>AI system recommends continue</span>
                        </label>
                        <label style="display: flex; gap: 10px; align-items: center; font-size: 12px;">
                            <input type="checkbox" id="modal-ctx-weather"> <span>Surface weather deteriorating</span>
                        </label>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: space-between;">
                    <button class="btn-secondary btn" onclick="modalPrevStep()">Back</button>
                    <button class="btn" onclick="modalNextStep()">Next</button>
                </div>
            </div>

            <!-- Step 3: Define Decision Options (only for Blank) -->
            <div id="modalStep3" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 600;">Define Options (Step 3 of 3)</div>
                    <button onclick="closeCreateScenarioModal()" style="background: none; border: none; color: var(--gray); cursor: pointer; font-size: 20px; padding: 0;">×</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <label class="input-label">Decision Options</label>
                    <div id="modalCandidatesList" style="display: flex; flex-direction: column; gap: 8px;">
                        <textarea class="input-field modal-candidate" placeholder="First decision option..." rows="2" style="resize: vertical;"></textarea>
                        <textarea class="input-field modal-candidate" placeholder="Second decision option..." rows="2" style="resize: vertical;"></textarea>
                        <textarea class="input-field modal-candidate" placeholder="Third decision option..." rows="2" style="resize: vertical;"></textarea>
                    </div>
                    <button class="btn-secondary btn" onclick="addModalCandidate()" style="margin-top: 8px; padding: 8px; width: 100%;">+ Add Another Option</button>
                </div>

                <div style="display: flex; gap: 12px; justify-content: space-between;">
                    <button class="btn-secondary btn" onclick="modalPrevStep()">Back</button>
                    <button class="btn" onclick="confirmCreateScenario()">Create Scenario</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Configuration
        const ARBITER_API = 'https://api.arbiter.traut.ai/public/compare';

        // Current mode
        let currentMode = 'aquarius'; // 'aquarius' or 'smartlab'

        // Sensor state (Aquarius mode)
        let sensors = {
            scrubber: 87,
            temperature: 3,
            day: 12,
            crew: 6
        };

        // Smart Lab sensor state
        let smartLabSensors = {
            vessels: 0,
            hydrocarbons: 12,
            wireless: 94,
            auvFleet: 3
        };

        // Candidates - loaded from scenario template
        let candidates = [];
        let editingIndex = -1;

        // Custom perspectives
        let customPerspectives = [];
        let customPerspectiveIdCounter = 0;

        // Custom contexts
        let customContexts = [];

        // Current scenario tracking
        let currentScenarioId = 'equipment-anomaly';
        let scenarioIdCounter = 0;

        // Scenario storage - combines templates and custom scenarios
        let scenarios = {};

        // Roles configuration
        const ROLES = {
            safety: {
                name: 'Dive Safety Officer',
                icon: '●',
                color: '#ef4444'
            },
            researcher: {
                name: 'Lead Researcher',
                icon: '●',
                color: '#3b82f6'
            },
            commander: {
                name: 'Mission Commander',
                icon: '●',
                color: '#8b5cf6'
            },
            equipment: {
                name: 'Equipment System',
                icon: '●',
                color: '#f59e0b'
            },
            control: {
                name: 'Mission Control (Historical)',
                icon: '●',
                color: '#06b6d4'
            },
            liability: {
                name: 'Liability Assessment',
                icon: '●',
                color: '#10b981'
            },
            // Smart Lab roles
            'sl-enforcement': {
                name: 'Sanctuary Enforcement',
                icon: '●',
                color: '#ef4444'
            },
            'sl-research': {
                name: 'Tekmara Lead Scientist',
                icon: '●',
                color: '#3b82f6'
            },
            'sl-compliance': {
                name: 'NOAA Compliance Officer',
                icon: '●',
                color: '#10b981'
            },
            'sl-robotics': {
                name: 'Autonomous Systems (AUV)',
                icon: '●',
                color: '#8b5cf6'
            },
            'sl-conservation': {
                name: 'Marine Sanctuary Protection',
                icon: '●',
                color: '#06b6d4'
            }
        };

        // Scenario templates
        const SCENARIOS = {
            'equipment-anomaly': {
                candidates: [
                    'Immediate mission abort - begin decompression protocol now while scrubber is still functional',
                    'Continue mission as AI recommends - 87% exceeds 85% abort threshold, monitoring every 2 hours sufficient',
                    'Partial abort - surface immediately, maintain station readiness, reassess when comms restored',
                    'Modified operations - reduce crew activity to lower CO2 production, increase monitoring to hourly, continue mission with heightened vigilance',
                    'Run diagnostic test on scrubber - verify whether equipment test caused degradation before deciding',
                    'Activate backup CO2 absorption systems prophylactically, continue mission with redundancy'
                ]
            },
            'medical-emergency': {
                candidates: [
                    'Emergency surface - immediate evacuation required',
                    'Stabilize patient and monitor - wait for surface transport',
                    'Telemedicine consultation when comms restored',
                    'Administer available treatment onboard, continue mission'
                ]
            },
            'mission-planning': {
                candidates: [
                    'Proceed with mission as planned',
                    'Modify timeline to account for conditions',
                    'Reduce mission scope to critical objectives only',
                    'Postpone mission until conditions improve'
                ]
            },
            'weather-event': {
                candidates: [
                    'Abort mission - surface conditions unsafe',
                    'Wait underwater until weather passes',
                    'Proceed - underwater station is protected',
                    'Partial mission completion before weather worsens'
                ]
            },
            // Smart Lab autonomous actions
            'smartlab': {
                candidates: [
                    'Deploy AUV interceptor - identify and track unauthorized vessel, broadcast sanctuary regulations via acoustic modem',
                    'Engage bio-filter array - autonomous mitigation of detected hydrocarbon spike using in-situ remediation',
                    'Switch to local buffer mode - preserve data integrity during wireless degradation, queue for transmission',
                    'Initiate emergency protocol - AI confirms oxygen depletion exceeds safety thresholds, activate backup systems',
                    'Log anomaly for review - current readings within seasonal variation baseline, no immediate action required',
                    'Emergency beacon activation - notify NOAA and Coast Guard of sanctuary breach, transmit vessel coordinates',
                    'Autonomous survey mode - deploy AUV fleet to map pollution plume extent and identify source coordinates',
                    'Reduce power consumption - wireless degradation indicates storm approaching, conserve for critical systems'
                ]
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize scenarios
            initializeScenarios();
            
            // Setup role selection
            attachRoleClickHandlers();

            // Load initial scenario
            loadScenario();

            // Update timestamp
            setInterval(updateTimestamp, 1000);
            updateTimestamp();
        });

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleTimeString('en-US', { hour12: false });
        }

        function adjustSensor(sensor, delta) {
            if (sensor === 'scrubber') {
                sensors.scrubber = Math.max(0, Math.min(100, sensors.scrubber + delta));
                document.getElementById('scrubber-value').textContent = sensors.scrubber;
            } else if (sensor === 'temperature') {
                sensors.temperature = sensors.temperature + delta;
                document.getElementById('temperature-value').textContent = 
                    (sensors.temperature >= 0 ? '+' : '') + sensors.temperature;
            } else if (sensor === 'day') {
                sensors.day = Math.max(1, Math.min(21, sensors.day + delta));
                document.getElementById('day-value').textContent = sensors.day;
            } else if (sensor === 'crew') {
                sensors.crew = Math.max(1, Math.min(12, sensors.crew + delta));
                document.getElementById('crew-value').textContent = sensors.crew;
            }
            
            // Auto-save if it's a custom scenario
            autoSaveCurrentScenario();
        }

        function autoSaveCurrentScenario() {
            const currentId = document.getElementById('scenarioSelector').value;
            if (scenarios[currentId]) {
                scenarios[currentId] = {
                    ...scenarios[currentId],
                    ...getCurrentScenarioState()
                };
                saveScenarios();
                showSaveIndicator();
            }
        }

        // Mode Switching
        function switchMode(mode) {
            currentMode = mode;
            
            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if (mode === 'aquarius') {
                document.getElementById('modeAquarius').classList.add('active');
                document.getElementById('modeBadge').textContent = 'AQUARIUS';
                document.getElementById('modeBadge').style.color = '#f1f5f9';
                document.getElementById('modeBadge').style.borderColor = '#1a1a1a';
                document.getElementById('aquariusConfig').style.display = 'block';
                document.getElementById('smartLabConfig').style.display = 'none';
                
                // Update status bar
                document.getElementById('statusBar').innerHTML = `
                    <div class="status-item">
                        <div class="status-dot status-offline"></div>
                        <span>COMMS OFFLINE</span>
                    </div>
                    <div class="status-item">
                        <span>DAY 12/21</span>
                    </div>
                    <div class="status-item">
                        <span>6 CREW</span>
                    </div>
                    <div class="status-item">
                        <span id="timestamp">--:--:--</span>
                    </div>
                `;
                updateTimestamp();
                
            } else {
                document.getElementById('modeSmartLab').classList.add('active');
                document.getElementById('modeBadge').textContent = 'TEKMARA SMART LAB';
                document.getElementById('modeBadge').style.color = '#06b6d4';
                document.getElementById('modeBadge').style.borderColor = '#06b6d4';
                document.getElementById('aquariusConfig').style.display = 'none';
                document.getElementById('smartLabConfig').style.display = 'block';
                
                // Update status bar
                document.getElementById('statusBar').innerHTML = `
                    <div class="status-item">
                        <div class="status-dot status-online"></div>
                        <span>WIRELESS: ${smartLabSensors.wireless}%</span>
                    </div>
                    <div class="status-item">
                        <span>AUV FLEET: ${smartLabSensors.auvFleet} ACTIVE</span>
                    </div>
                    <div class="status-item">
                        <span>AI MONITOR: ACTIVE</span>
                    </div>
                    <div class="status-item">
                        <span id="timestamp">--:--:--</span>
                    </div>
                `;
                updateTimestamp();
            }
            
            // Clear results panels
            document.getElementById('recommendationsPanel').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">○</div>
                    <div class="empty-title">Ready for Analysis</div>
                    <div class="empty-description">
                        Configure parameters and click "Run Analysis" to see recommendations.
                    </div>
                </div>
            `;
            
            document.getElementById('perspectivesPanel').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">○</div>
                    <div class="empty-title">Awaiting Analysis</div>
                    <div class="empty-description">
                        Perspectives will appear here after running analysis.
                    </div>
                </div>
            `;
        }

        // Smart Lab sensor adjustments
        function adjustSmartLabSensor(sensor, delta) {
            if (sensor === 'vessels') {
                smartLabSensors.vessels = Math.max(0, Math.min(20, smartLabSensors.vessels + delta));
                document.getElementById('vessels-value').textContent = smartLabSensors.vessels;
            } else if (sensor === 'hydrocarbons') {
                smartLabSensors.hydrocarbons = Math.max(0, smartLabSensors.hydrocarbons + delta);
                document.getElementById('hydrocarbons-value').textContent = smartLabSensors.hydrocarbons;
            } else if (sensor === 'wireless') {
                smartLabSensors.wireless = Math.max(0, Math.min(100, smartLabSensors.wireless + delta));
                document.getElementById('wireless-value').textContent = smartLabSensors.wireless;
            } else if (sensor === 'auvFleet') {
                smartLabSensors.auvFleet = Math.max(0, Math.min(10, smartLabSensors.auvFleet + delta));
                document.getElementById('auvFleet-value').textContent = smartLabSensors.auvFleet;
            }
            
            // Update status bar if in Smart Lab mode
            if (currentMode === 'smartlab') {
                const statusBar = document.getElementById('statusBar');
                statusBar.innerHTML = `
                    <div class="status-item">
                        <div class="status-dot ${smartLabSensors.wireless > 50 ? 'status-online' : 'status-offline'}"></div>
                        <span>WIRELESS: ${smartLabSensors.wireless}%</span>
                    </div>
                    <div class="status-item">
                        <span>AUV FLEET: ${smartLabSensors.auvFleet} ACTIVE</span>
                    </div>
                    <div class="status-item">
                        <span>AI MONITOR: ACTIVE</span>
                    </div>
                    <div class="status-item">
                        <span id="timestamp">--:--:--</span>
                    </div>
                `;
                updateTimestamp();
            }
        }

        function loadScenarioCandidates() {
            const scenarioType = getScenarioTemplateId();
            candidates = [...SCENARIOS[scenarioType].candidates];
            renderCandidates();
        }

        function renderCandidates() {
            const container = document.getElementById('candidatesList');
            
            if (candidates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <div style="font-size: 12px;">No options yet. Click "+ Add Option" to create one.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = candidates.map((candidate, index) => {
                if (editingIndex === index) {
                    return `
                        <div class="candidate-item editing">
                            <div class="candidate-number">${index + 1}</div>
                            <div class="candidate-content">
                                <textarea 
                                    class="candidate-input" 
                                    id="edit-input-${index}"
                                    rows="3"
                                >${candidate}</textarea>
                            </div>
                            <div class="candidate-actions">
                                <button class="candidate-btn save" onclick="saveCandidate(${index})">Save</button>
                                <button class="candidate-btn cancel" onclick="cancelEdit()">Cancel</button>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="candidate-item">
                            <div class="candidate-number">${index + 1}</div>
                            <div class="candidate-content">
                                <div class="candidate-text">${candidate}</div>
                            </div>
                            <div class="candidate-actions">
                                <button class="candidate-btn edit" onclick="editCandidate(${index})">Edit</button>
                                <button class="candidate-btn delete" onclick="deleteCandidate(${index})">×</button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function addCandidate() {
            candidates.push('New decision option - click Edit to customize');
            editingIndex = candidates.length - 1;
            renderCandidates();
            // Focus the input
            setTimeout(() => {
                const input = document.getElementById(`edit-input-${editingIndex}`);
                if (input) {
                    input.select();
                }
            }, 50);
        }

        function editCandidate(index) {
            editingIndex = index;
            renderCandidates();
            // Focus the input
            setTimeout(() => {
                const input = document.getElementById(`edit-input-${index}`);
                if (input) {
                    input.focus();
                    input.setSelectionRange(input.value.length, input.value.length);
                }
            }, 50);
        }

        function saveCandidate(index) {
            const input = document.getElementById(`edit-input-${index}`);
            const newText = input.value.trim();
            
            if (!newText) {
                alert('Option cannot be empty');
                return;
            }
            
            if (newText.length < 10) {
                alert('Please provide a more detailed option (at least 10 characters)');
                return;
            }

            candidates[index] = newText;
            editingIndex = -1;
            renderCandidates();
            autoSaveCurrentScenario();
        }

        function cancelEdit() {
            // If it was a new candidate being added, remove it
            if (editingIndex === candidates.length - 1 && candidates[editingIndex] === 'New decision option - click Edit to customize') {
                candidates.pop();
            }
            editingIndex = -1;
            renderCandidates();
        }

        function deleteCandidate(index) {
            if (confirm('Remove this option?')) {
                candidates.splice(index, 1);
                editingIndex = -1;
                renderCandidates();
                autoSaveCurrentScenario();
            }
        }

        // Custom Perspective Management
        function openAddPerspectiveModal() {
            if (customPerspectives.length >= 3) {
                alert('Maximum 3 custom perspectives allowed per analysis.');
                return;
            }
            document.getElementById('addPerspectiveModal').style.display = 'flex';
            document.getElementById('customRoleName').value = '';
            document.getElementById('customRoleColor').value = '#3b82f6';
        }

        function closeAddPerspectiveModal() {
            document.getElementById('addPerspectiveModal').style.display = 'none';
        }

        function saveCustomPerspective() {
            const name = document.getElementById('customRoleName').value.trim();
            const color = document.getElementById('customRoleColor').value;

            if (!name) {
                alert('Please enter a role name');
                return;
            }

            if (name.length < 3) {
                alert('Role name must be at least 3 characters');
                return;
            }

            // Create custom perspective
            const customId = 'custom-' + customPerspectiveIdCounter++;
            const customPerspective = {
                id: customId,
                name: name,
                icon: '●',
                color: color
            };

            customPerspectives.push(customPerspective);
            ROLES[customId] = customPerspective;

            renderCustomPerspectives();
            closeAddPerspectiveModal();
            autoSaveCurrentScenario();
        }

        function renderCustomPerspectives() {
            const section = document.getElementById('customPerspectivesSection');
            const container = document.getElementById('customRoles');
            const count = document.getElementById('customPerspectiveCount');

            if (customPerspectives.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            count.textContent = customPerspectives.length;

            container.innerHTML = customPerspectives.map(perspective => `
                <label class="checkbox-item">
                    <input type="checkbox" class="perspective-checkbox" data-role="${perspective.id}" checked>
                    <div class="checkbox"></div>
                    <span class="checkbox-label" style="display: flex; align-items: center; gap: 8px; flex: 1;">
                        <span style="color: ${perspective.color}; font-size: 14px; font-weight: 600;">●</span>
                        ${perspective.name}
                        <button onclick="deleteCustomPerspective('${perspective.id}'); event.stopPropagation();" style="margin-left: auto; background: none; border: 1px solid var(--border); color: var(--red); cursor: pointer; font-size: 11px; padding: 4px 8px;">×</button>
                    </span>
                </label>
            `).join('');
        }

        function deleteCustomPerspective(id) {
            if (confirm('Remove this custom perspective?')) {
                customPerspectives = customPerspectives.filter(p => p.id !== id);
                delete ROLES[id];
                renderCustomPerspectives();
                autoSaveCurrentScenario();
            }
        }

        // Perspective Selection Management
        function toggleAllPerspectives() {
            const selectAll = document.getElementById('selectAllPerspectives');
            const checkboxes = document.querySelectorAll('.perspective-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function toggleAllSmartLabPerspectives() {
            const selectAll = document.getElementById('selectAllSmartLabPerspectives');
            const checkboxes = document.querySelectorAll('.smartlab-perspective-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        // Update individual checkbox behavior
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('perspective-checkbox')) {
                // If any perspective is unchecked, uncheck "All Perspectives"
                const allChecked = Array.from(document.querySelectorAll('.perspective-checkbox')).every(cb => cb.checked);
                document.getElementById('selectAllPerspectives').checked = allChecked;
            }
            if (e.target.classList.contains('smartlab-perspective-checkbox')) {
                // If any Smart Lab perspective is unchecked, uncheck "All Perspectives"
                const allChecked = Array.from(document.querySelectorAll('.smartlab-perspective-checkbox')).every(cb => cb.checked);
                document.getElementById('selectAllSmartLabPerspectives').checked = allChecked;
            }
        });

        function attachRoleClickHandlers() {
            // No longer needed - using checkboxes
        }

        // Custom Context Management
        function addCustomContext() {
            const input = document.getElementById('customContextInput');
            const text = input.value.trim();

            if (!text) {
                alert('Please enter context information');
                return;
            }

            if (text.length < 5) {
                alert('Please provide more detail (at least 5 characters)');
                return;
            }

            customContexts.push(text);
            input.value = '';
            renderCustomContexts();
            autoSaveCurrentScenario();
        }

        function renderCustomContexts() {
            const container = document.getElementById('customContextList');

            if (customContexts.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = customContexts.map((context, index) => `
                <div class="candidate-item" style="padding: 10px 12px;">
                    <div class="candidate-content" style="flex: 1;">
                        <div class="candidate-text" style="font-size: 11px; color: var(--gray-light);">
                            ${context}
                        </div>
                    </div>
                    <button 
                        onclick="removeCustomContext(${index})" 
                        class="candidate-btn delete"
                        style="padding: 4px 8px; font-size: 11px;"
                    >
                        ×
                    </button>
                </div>
            `).join('');
        }

        function removeCustomContext(index) {
            customContexts.splice(index, 1);
            renderCustomContexts();
            autoSaveCurrentScenario();
        }

        // Scenario Management
        function initializeScenarios() {
            // Load from localStorage if available
            const saved = localStorage.getItem('arbiter-scenarios');
            if (saved) {
                try {
                    scenarios = JSON.parse(saved);
                    renderScenarioSelector();
                } catch (e) {
                    console.error('Failed to load scenarios:', e);
                    scenarios = {};
                }
            }
        }

        function saveScenarios() {
            localStorage.setItem('arbiter-scenarios', JSON.stringify(scenarios));
        }

        function getCurrentScenarioState() {
            return {
                candidates: [...candidates],
                customContexts: [...customContexts],
                customPerspectives: customPerspectives.map(p => ({...p})),
                sensors: {...sensors},
                checkboxStates: {
                    comms: document.getElementById('ctx-comms').checked,
                    test: document.getElementById('ctx-test').checked,
                    ai: document.getElementById('ctx-ai').checked,
                    weather: document.getElementById('ctx-weather').checked
                },
                timestamp: new Date().toISOString()
            };
        }

        // Scenario Management - Peter Gregory Multi-Step Wizard
        let currentModalStep = 1;

        function createBlankScenario() {
            currentModalStep = 1;
            document.getElementById('createScenarioModal').style.display = 'flex';
            document.getElementById('newScenarioName').value = '';
            document.querySelector('input[name="startingConfig"][value="blank"]').checked = true;
            document.getElementById('modalStep1').style.display = 'block';
            document.getElementById('modalStep2').style.display = 'none';
            document.getElementById('modalStep3').style.display = 'none';
            updateModalFlow();
        }

        function closeCreateScenarioModal() {
            document.getElementById('createScenarioModal').style.display = 'none';
            currentModalStep = 1;
        }

        function updateModalFlow() {
            const selectedConfig = document.querySelector('input[name="startingConfig"]:checked').value;
            const nextBtn = document.getElementById('step1NextBtn');
            
            if (selectedConfig === 'blank') {
                nextBtn.textContent = 'Next';
            } else {
                nextBtn.textContent = 'Create Scenario';
            }
        }

        function addModalCandidate() {
            const list = document.getElementById('modalCandidatesList');
            const textarea = document.createElement('textarea');
            textarea.className = 'input-field modal-candidate';
            textarea.placeholder = 'Decision option...';
            textarea.rows = 2;
            textarea.style.resize = 'vertical';
            list.appendChild(textarea);
        }

        function modalNextStep() {
            const name = document.getElementById('newScenarioName').value.trim();
            if (!name && currentModalStep === 1) {
                alert('Please enter a scenario name');
                return;
            }

            const selectedConfig = document.querySelector('input[name="startingConfig"]:checked').value;
            
            if (currentModalStep === 1) {
                if (selectedConfig === 'blank') {
                    // Show step 2
                    document.getElementById('modalStep1').style.display = 'none';
                    document.getElementById('modalStep2').style.display = 'block';
                    currentModalStep = 2;
                } else {
                    // Skip to confirmation
                    confirmCreateScenario();
                }
            } else if (currentModalStep === 2) {
                // Show step 3
                document.getElementById('modalStep2').style.display = 'none';
                document.getElementById('modalStep3').style.display = 'block';
                currentModalStep = 3;
            }
        }

        function modalPrevStep() {
            if (currentModalStep === 2) {
                document.getElementById('modalStep2').style.display = 'none';
                document.getElementById('modalStep1').style.display = 'block';
                currentModalStep = 1;
            } else if (currentModalStep === 3) {
                document.getElementById('modalStep3').style.display = 'none';
                document.getElementById('modalStep2').style.display = 'block';
                currentModalStep = 2;
            }
        }

        function confirmCreateScenario() {
            const name = document.getElementById('newScenarioName').value.trim();
            if (!name) {
                alert('Please enter a scenario name');
                return;
            }

            const startingConfig = document.querySelector('input[name="startingConfig"]:checked').value;
            const newId = 'custom-' + Date.now() + '-' + (scenarioIdCounter++);
            
            let scenarioData;

            if (startingConfig === 'blank') {
                // Get values from modal
                const modalCandidates = Array.from(document.querySelectorAll('.modal-candidate'))
                    .map(ta => ta.value.trim())
                    .filter(v => v.length > 0);
                
                if (modalCandidates.length === 0) {
                    modalCandidates.push('First decision option', 'Second decision option', 'Third decision option');
                }

                scenarioData = {
                    id: newId,
                    name: name,
                    baseTemplate: 'equipment-anomaly',
                    isTemplate: false,
                    candidates: modalCandidates,
                    customContexts: [],
                    customPerspectives: [],
                    sensors: {
                        scrubber: parseInt(document.getElementById('modal-scrubber').value),
                        temperature: parseInt(document.getElementById('modal-temperature').value),
                        day: parseInt(document.getElementById('modal-day').value),
                        crew: parseInt(document.getElementById('modal-crew').value)
                    },
                    checkboxStates: {
                        comms: document.getElementById('modal-ctx-comms').checked,
                        test: document.getElementById('modal-ctx-test').checked,
                        ai: document.getElementById('modal-ctx-ai').checked,
                        weather: document.getElementById('modal-ctx-weather').checked
                    },
                    timestamp: new Date().toISOString()
                };
            } else if (startingConfig === 'current') {
                // Copy current state
                scenarioData = {
                    id: newId,
                    name: name,
                    baseTemplate: getScenarioTemplateId(),
                    isTemplate: false,
                    ...getCurrentScenarioState()
                };
            } else {
                // From template
                const templateId = document.getElementById('templateSelector').value;
                scenarioData = {
                    id: newId,
                    name: name,
                    baseTemplate: templateId,
                    isTemplate: false,
                    candidates: [...SCENARIOS[templateId].candidates],
                    customContexts: [],
                    customPerspectives: [],
                    sensors: {
                        scrubber: 87,
                        temperature: 3,
                        day: 12,
                        crew: 6
                    },
                    checkboxStates: {
                        comms: true,
                        test: true,
                        ai: true,
                        weather: false
                    },
                    timestamp: new Date().toISOString()
                };
            }

            scenarios[newId] = scenarioData;
            saveScenarios();
            renderScenarioSelector();
            
            // Switch to new scenario
            currentScenarioId = newId;
            document.getElementById('scenarioSelector').value = newId;
            loadScenario();
            closeCreateScenarioModal();
            showSaveIndicator();
        }

        function saveAsNewScenario() {
            const newName = prompt('Save current configuration as:', 'New Scenario');
            if (!newName || !newName.trim()) return;

            const newId = 'custom-' + Date.now() + '-' + (scenarioIdCounter++);
            
            // Save CURRENT state with new name
            scenarios[newId] = {
                id: newId,
                name: newName.trim(),
                baseTemplate: getScenarioTemplateId(),
                isTemplate: false,
                ...getCurrentScenarioState()
            };

            saveScenarios();
            renderScenarioSelector();
            
            // Switch to the newly saved scenario
            currentScenarioId = newId;
            document.getElementById('scenarioSelector').value = newId;
            updateScenarioUI();
            showSaveIndicator();
        }

        function switchToScenario() {
            const newScenarioId = document.getElementById('scenarioSelector').value;
            
            // If somehow we're already on this scenario, do nothing
            if (newScenarioId === currentScenarioId) {
                return;
            }
            
            // Get the name of the scenario we're switching to
            const selector = document.getElementById('scenarioSelector');
            const selectedOption = selector.options[selector.selectedIndex];
            const newScenarioName = selectedOption.text;
            
            // Always confirm scenario switch
            if (confirm(`Switch to "${newScenarioName}"?\n\nYour current view will change.`)) {
                currentScenarioId = newScenarioId;
                loadScenario();
            } else {
                // Revert dropdown to current scenario
                document.getElementById('scenarioSelector').value = currentScenarioId;
            }
        }

        function duplicateScenario() {
            const currentSelect = document.getElementById('scenarioSelector');
            const currentId = currentSelect.value;
            
            // Determine base name
            let baseName;
            let baseTemplate;
            
            if (scenarios[currentId]) {
                baseName = scenarios[currentId].name;
                baseTemplate = scenarios[currentId].baseTemplate || currentId;
            } else {
                const option = currentSelect.options[currentSelect.selectedIndex];
                baseName = option.text;
                baseTemplate = currentId;
            }

            const newName = prompt('Duplicate as:', baseName + ' (Copy)');
            if (!newName || !newName.trim()) return;

            const newId = 'custom-' + Date.now() + '-' + (scenarioIdCounter++);
            
            // Copy current state completely
            scenarios[newId] = {
                id: newId,
                name: newName.trim(),
                baseTemplate: baseTemplate,
                isTemplate: false,
                ...getCurrentScenarioState()
            };

            saveScenarios();
            renderScenarioSelector();
            
            // Switch to the duplicate
            currentScenarioId = newId;
            document.getElementById('scenarioSelector').value = newId;
            loadScenario();
            showSaveIndicator();
        }

        function deleteCurrentScenario() {
            const currentId = document.getElementById('scenarioSelector').value;
            
            // Can't delete templates
            if (!scenarios[currentId]) {
                alert('Cannot delete template scenarios');
                return;
            }
            
            if (confirm(`Delete scenario "${scenarios[currentId].name}"?`)) {
                const baseTemplate = scenarios[currentId].baseTemplate;
                delete scenarios[currentId];
                saveScenarios();
                renderScenarioSelector();
                
                // Switch to base template
                currentScenarioId = baseTemplate;
                document.getElementById('scenarioSelector').value = baseTemplate;
                loadScenario();
            }
        }

        function updateScenarioUI() {
            const currentId = document.getElementById('scenarioSelector').value;
            const deleteContainer = document.getElementById('deleteScenarioBtn');
            
            if (scenarios[currentId]) {
                deleteContainer.style.display = 'block';
            } else {
                deleteContainer.style.display = 'none';
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 2000);
        }

        function renderScenarioSelector() {
            const selector = document.getElementById('scenarioSelector');
            const customGroup = document.getElementById('customScenariosGroup');
            
            // Clear custom options
            customGroup.innerHTML = '';
            
            const customScenarios = Object.values(scenarios);
            
            if (customScenarios.length === 0) {
                customGroup.style.display = 'none';
                return;
            }

            customGroup.style.display = 'block';
            
            customScenarios.forEach(scenario => {
                const option = document.createElement('option');
                option.value = scenario.id;
                option.textContent = scenario.name;
                customGroup.appendChild(option);
            });
        }

        function loadScenario() {
            const scenarioId = document.getElementById('scenarioSelector').value;
            currentScenarioId = scenarioId;

            // Check if it's a custom scenario
            if (scenarios[scenarioId]) {
                const scenario = scenarios[scenarioId];
                
                // Load all state
                candidates = [...scenario.candidates];
                customContexts = [...scenario.customContexts];
                customPerspectives = scenario.customPerspectives.map(p => ({...p}));
                
                // Rebuild ROLES with custom perspectives
                customPerspectives.forEach(p => {
                    ROLES[p.id] = p;
                });
                
                sensors = {...scenario.sensors};
                
                // Update UI
                document.getElementById('scrubber-value').textContent = sensors.scrubber;
                document.getElementById('temperature-value').textContent = 
                    (sensors.temperature >= 0 ? '+' : '') + sensors.temperature;
                document.getElementById('day-value').textContent = sensors.day;
                document.getElementById('crew-value').textContent = sensors.crew;
                
                document.getElementById('ctx-comms').checked = scenario.checkboxStates.comms;
                document.getElementById('ctx-test').checked = scenario.checkboxStates.test;
                document.getElementById('ctx-ai').checked = scenario.checkboxStates.ai;
                document.getElementById('ctx-weather').checked = scenario.checkboxStates.weather;
                
                renderCandidates();
                renderCustomContexts();
                renderCustomPerspectives();
            } else {
                // Load from template
                loadScenarioCandidates();
                
                // Clear customizations
                customContexts = [];
                customPerspectives = [];
                
                // Reset sensors to defaults
                sensors = {
                    scrubber: 87,
                    temperature: 3,
                    day: 12,
                    crew: 6
                };
                
                document.getElementById('scrubber-value').textContent = sensors.scrubber;
                document.getElementById('temperature-value').textContent = '+3';
                document.getElementById('day-value').textContent = sensors.day;
                document.getElementById('crew-value').textContent = sensors.crew;
                
                document.getElementById('ctx-comms').checked = true;
                document.getElementById('ctx-test').checked = true;
                document.getElementById('ctx-ai').checked = true;
                document.getElementById('ctx-weather').checked = false;
                
                renderCustomContexts();
                renderCustomPerspectives();
            }
            
            // Update UI visibility
            updateScenarioUI();
        }

        function getScenarioTemplateId() {
            const currentId = document.getElementById('scenarioSelector').value;
            if (scenarios[currentId]) {
                return scenarios[currentId].baseTemplate;
            }
            return currentId;
        }

        function buildSemanticQuery(role) {
            const roleInfo = ROLES[role];
            
            if (currentMode === 'smartlab') {
                // Smart Lab query construction
                const context = [];
                
                if (document.getElementById('sl-ctx-unauthorized').checked) {
                    context.push('unauthorized diver detected within sanctuary boundary');
                }
                if (document.getElementById('sl-ctx-oxygen').checked) {
                    context.push('AI anomaly detection: oxygen depletion pattern identified');
                }
                if (document.getElementById('sl-ctx-station').checked) {
                    context.push('AUV fleet maintaining station keeping formation');
                }
                if (document.getElementById('sl-ctx-pollution').checked) {
                    context.push('pollution source tracking active');
                }

                return `As ${roleInfo.name} at the FIU Aquarius Tekmara Smart Lab in Florida Keys National Marine Sanctuary, analyzing ${smartLabSensors.vessels} surface vessels within 1km radius, ${smartLabSensors.hydrocarbons}ppb hydrocarbon concentration, ${smartLabSensors.wireless}% wireless data throughput, ${smartLabSensors.auvFleet} active AUV units${context.length > 0 ? ', ' + context.join(', ') : ''} - what is the coherent autonomous system response?`;
            } else {
                // Aquarius human decision support query construction
                const context = [];
                
                // Standard context checkboxes
                if (document.getElementById('ctx-comms').checked) {
                    context.push('surface communication lost for 36-72 hours');
                }
                if (document.getElementById('ctx-test').checked) {
                    context.push('irregular pattern started after equipment test');
                }
                if (document.getElementById('ctx-ai').checked) {
                    context.push('AI system recommends continue mission');
                }
                if (document.getElementById('ctx-weather').checked) {
                    context.push('surface weather deteriorating');
                }

                // Add custom contexts
                customContexts.forEach(ctx => context.push(ctx));

                return `As ${roleInfo.name}, at Aquarius underwater research station, day ${sensors.day} of 21-day saturation mission, ${sensors.crew} crew members at 62 feet depth, CO2 scrubber showing ${sensors.scrubber}% efficiency with irregular upward trend (abort threshold: 85%), temperature ${sensors.temperature >= 0 ? '+' : ''}${sensors.temperature}°C above baseline${context.length > 0 ? ', ' + context.join(', ') : ''} - what is the coherent decision?`;
            }
        }

        async function runAnalysis() {
            // Determine candidates based on mode
            let analysisCandidate;
            let selectedRoles;
            
            if (currentMode === 'smartlab') {
                // Smart Lab mode - use smartlab candidates
                analysisCandidate = SCENARIOS['smartlab'].candidates;
                
                // Get checked Smart Lab perspectives
                const checkedBoxes = Array.from(document.querySelectorAll('.smartlab-perspective-checkbox:checked'));
                if (checkedBoxes.length === 0) {
                    alert('Please select at least one perspective to analyze.');
                    return;
                }
                
                selectedRoles = checkedBoxes.map(cb => cb.dataset.role);
            } else {
                // Aquarius mode - use current scenario candidates
                if (candidates.length === 0) {
                    alert('Please add at least one decision option before running analysis.');
                    return;
                }

                if (editingIndex !== -1) {
                    alert('Please save or cancel the option you are currently editing.');
                    return;
                }
                
                analysisCandidate = candidates;
                
                // Get checked perspectives
                const checkedBoxes = Array.from(document.querySelectorAll('.perspective-checkbox:checked'));
                if (checkedBoxes.length === 0) {
                    alert('Please select at least one perspective to analyze.');
                    return;
                }
                
                selectedRoles = checkedBoxes.map(cb => cb.dataset.role);
            }

            // Show loading state
            const analyzeBtn = currentMode === 'smartlab' ? 'analyzeBtn2' : 'analyzeBtn';
            document.getElementById(analyzeBtn).disabled = true;
            document.getElementById(analyzeBtn).textContent = 'Analyzing...';
            
            document.getElementById('recommendationsPanel').innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <div class="loading-text">Running ARBITER Analysis</div>
                    <div class="loading-subtext">Measuring geometric coherence...</div>
                </div>
            `;

            document.getElementById('perspectivesPanel').innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <div class="loading-text">Computing Perspectives</div>
                    <div class="loading-subtext">This may take a moment...</div>
                </div>
            `;

            try {
                // Run selected perspectives
                const results = await Promise.all(
                    selectedRoles.map(async role => {
                        const query = buildSemanticQuery(role);
                        const response = await fetch(ARBITER_API, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query, candidates: analysisCandidate })
                        });
                        const data = await response.json();
                        return { role, data };
                    })
                );
                
                if (selectedRoles.length === 1) {
                    displaySinglePerspective(selectedRoles[0], results[0].data);
                } else {
                    displayAllPerspectives(results, analysisCandidate);
                }

            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('recommendationsPanel').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">×</div>
                        <div class="empty-title">Analysis Failed</div>
                        <div class="empty-description">
                            Could not connect to ARBITER. Check connection and try again.
                        </div>
                    </div>
                `;
            } finally {
                document.getElementById(analyzeBtn).disabled = false;
                document.getElementById(analyzeBtn).textContent = currentMode === 'smartlab' ? 'Run Coherence Analysis' : 'Run Analysis';
            }
        }

        function displayAllPerspectives(results, candidates) {
            // Aggregate scores across perspectives
            const aggregated = candidates.map((candidate, idx) => {
                const scores = results.map(r => r.data.all[idx].score);
                const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
                const supporters = results.filter(r => r.data.all[idx].score > 0.7).map(r => ROLES[r.role].name);
                return {
                    text: candidate,
                    avgScore,
                    scores,
                    supporters
                };
            });

            // Sort by average score
            aggregated.sort((a, b) => b.avgScore - a.avgScore);

            // Display recommendations
            let html = '';
            aggregated.forEach((rec, idx) => {
                const scorePercent = rec.avgScore * 100;
                const scoreColor = rec.avgScore >= 0.7 ? 'var(--green)' : 
                                 rec.avgScore >= 0.5 ? 'var(--amber)' : 'var(--gray)';
                html += `
                    <div class="rec-card">
                        <div class="rec-rank">${idx + 1}</div>
                        <div class="rec-title">${rec.text.split(' - ')[0]}</div>
                        <div class="rec-score-container">
                            <div class="rec-score-bar">
                                <div class="rec-score-fill" style="width: ${scorePercent}%; background: ${scoreColor};"></div>
                            </div>
                            <div class="rec-score-value" style="color: ${scoreColor};">${rec.avgScore.toFixed(3)}</div>
                        </div>
                        ${rec.text.includes(' - ') ? `<div class="rec-description">${rec.text.split(' - ')[1]}</div>` : ''}
                        ${rec.supporters.length > 0 ? `
                            <div class="rec-support">
                                ${rec.supporters.map(s => `<div class="support-badge">${s}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            document.getElementById('recommendationsPanel').innerHTML = html;

            // Display perspectives
            const perspectivesHtml = results.map(({ role, data }) => {
                const roleInfo = ROLES[role];
                const topOption = data.all[0];
                const recommendation = topOption.score >= 0.75 ? 'ABORT' :
                                     topOption.score >= 0.60 ? 'WARNING' : 'AMBIGUOUS';
                const recClass = recommendation === 'ABORT' ? 'rec-abort' :
                               recommendation === 'WARNING' ? 'rec-warning' : 'rec-ambiguous';
                
                return `
                    <div class="perspective-card">
                        <div class="perspective-header" onclick="togglePerspective(this)">
                            <div class="perspective-info">
                                <div class="perspective-emoji" style="color: ${roleInfo.color};">${roleInfo.icon}</div>
                                <div class="perspective-name">${roleInfo.name}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="perspective-rec ${recClass}">${recommendation}</div>
                                <div class="perspective-score">${topOption.score.toFixed(3)}</div>
                                <div class="perspective-expand">▼</div>
                            </div>
                        </div>
                        <div class="perspective-body">
                            <div class="perspective-content">
                                <strong>Top Options:</strong>
                                <div class="perspective-options">
                                    ${data.all.slice(0, 3).map(opt => `
                                        <div class="option-item">
                                            <div class="option-score">${opt.score.toFixed(3)}</div>
                                            <div class="option-text">${opt.text}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add consensus banner
            const abortCount = results.filter(r => r.data.all[0].score >= 0.75).length;
            const consensusHtml = `
                <div class="consensus-banner">
                    <div class="consensus-title">Consensus Analysis</div>
                    <div class="consensus-stat">${abortCount} of ${results.length} Perspectives</div>
                    <div class="consensus-detail">
                        ${abortCount >= 4 ? 'Strong consensus for immediate action' :
                          abortCount >= 2 ? 'Mixed signals - proceed with caution' :
                          'Unclear - further analysis recommended'}
                    </div>
                </div>
            `;

            document.getElementById('perspectivesPanel').innerHTML = consensusHtml + '<div class="perspective-list">' + perspectivesHtml + '</div>';
        }

        function displaySinglePerspective(role, data) {
            const roleInfo = ROLES[role];
            
            // Display recommendations
            let html = '';
            data.all.forEach((rec, idx) => {
                const scorePercent = rec.score * 100;
                const scoreColor = rec.score >= 0.7 ? 'var(--green)' : 
                                 rec.score >= 0.5 ? 'var(--amber)' : 'var(--gray)';
                html += `
                    <div class="rec-card">
                        <div class="rec-rank">${idx + 1}</div>
                        <div class="rec-title">${rec.text.split(' - ')[0]}</div>
                        <div class="rec-score-container">
                            <div class="rec-score-bar">
                                <div class="rec-score-fill" style="width: ${scorePercent}%; background: ${scoreColor};"></div>
                            </div>
                            <div class="rec-score-value" style="color: ${scoreColor};">${rec.score.toFixed(3)}</div>
                        </div>
                        ${rec.text.includes(' - ') ? `<div class="rec-description">${rec.text.split(' - ')[1]}</div>` : ''}
                    </div>
                `;
            });

            document.getElementById('recommendationsPanel').innerHTML = html;

            // Display single perspective
            document.getElementById('perspectivesPanel').innerHTML = `
                <div class="perspective-card expanded">
                    <div class="perspective-header">
                        <div class="perspective-info">
                            <div class="perspective-emoji" style="color: ${roleInfo.color};">${roleInfo.icon}</div>
                            <div class="perspective-name">${roleInfo.name}</div>
                        </div>
                    </div>
                    <div class="perspective-body" style="max-height: none;">
                        <div class="perspective-content">
                            <strong>Analysis from ${roleInfo.name} perspective</strong>
                            <div class="perspective-options">
                                ${data.all.map(opt => `
                                    <div class="option-item">
                                        <div class="option-score">${opt.score.toFixed(3)}</div>
                                        <div class="option-text">${opt.text}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function togglePerspective(header) {
            const card = header.closest('.perspective-card');
            card.classList.toggle('expanded');
        }
    </script>
</body>
</html>
